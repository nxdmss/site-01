# Диагностика проблемы с аватарками

## Шаг 1: Проверка в браузере (DevTools)

1. Откройте сайт и зайдите в личный кабинет `/cabinet`
2. Откройте DevTools (F12) → вкладка Console
3. Вы должны увидеть лог: `Loaded user data: { email: "...", hasAvatar: true/false, avatarLength: ... }`

**Если `hasAvatar: false` или `avatarLength: null`:**
- Аватар не загружен с сервера → проверьте шаг 2

**Если `hasAvatar: true`:**
- Аватар загрузился, но не отображается → проверьте шаг 4

## Шаг 2: Проверка в базе данных

Подключитесь к БД через DBeaver или psql:

```sql
-- Проверить, есть ли аватары у пользователей
SELECT 
    id, 
    email, 
    CASE 
        WHEN avatar IS NULL THEN 'НЕТ' 
        ELSE CONCAT('ЕСТЬ (', LENGTH(avatar), ' символов)')
    END as avatar_status
FROM users;
```

**Если у вашего пользователя `avatar_status = 'НЕТ'`:**
- Аватар не сохранён в БД → попробуйте загрузить его снова (шаг 3)

## Шаг 3: Загрузка аватара

1. В личном кабинете нажмите "Загрузить фото"
2. Выберите картинку (до 5 МБ)
3. В Console должны появиться логи:
   ```
   Uploading avatar, size: 12345
   Avatar uploaded, response: { hasAvatar: true, avatarLength: 12345 }
   ```

4. Проверьте в БД (шаг 2) — должно стать `ЕСТЬ (...)`

**Если в Console ошибка:**
- Откройте DevTools → Network → найдите запрос `PUT /users/avatar`
- Посмотрите Response — должен быть статус 200
- Если 400/500 — скопируйте текст ошибки

## Шаг 4: Проверка отображения

Если аватар в БД есть, но не отображается:

1. Проверьте в DevTools → Elements → найдите `.profile-avatar`
2. Посмотрите атрибут `src` у `<img>` — должен начинаться с `data:image/...`

**Если `src` пустой или `null`:**
- Проблема в frontend — avatar не передаётся в компонент
- Проверьте Console — есть ли лог `Loaded user data`?

**Если `src` правильный, но картинка не видна:**
- Возможно, Base64 строка некорректна
- Попробуйте удалить аватар и загрузить снова

## Шаг 5: Тестирование через скрипт

```bash
cd backend
python test_avatar.py
```

Введите email и пароль — скрипт проверит весь flow загрузки/удаления.

## Частые проблемы и решения

### Аватар исчезает после обновления страницы
**Причина:** Не сохраняется в БД  
**Решение:** Проверьте логи бэкенда, возможно ошибка при `db.commit()`

### Аватар есть, но показывается только на одном устройстве
**Причина:** Хранится в localStorage, а не в БД (старая версия кода)  
**Решение:** Убедитесь, что используете последнюю версию с GitHub (коммит `6ae7a3e` или новее)

### Ошибка 422 при загрузке
**Причина:** Backend не принимает `null` для удаления  
**Решение:** Обновите `backend/schemas.py` (должно быть `avatar: str | None`)

### Картинка серая или не грузится
**Причина:** Некорректный Base64 или слишком большой файл  
**Решение:** 
- Проверьте размер файла (должен быть < 5 МБ)
- Попробуйте другую картинку (JPG/PNG)
- Проверьте длину Base64 в БД — если > 10 MB, картинка слишком большая

## Нужна помощь?

1. Откройте DevTools → Console — скопируйте все логи
2. Выполните SQL из шага 2 — скопируйте результат (без Base64!)
3. Откройте DevTools → Network → найдите запрос `/users/avatar` → скопируйте Response
4. Отправьте мне все 3 пункта — помогу разобраться!
