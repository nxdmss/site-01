#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ¡ĞšĞ Ğ˜ĞŸĞ¢ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜ Ğ‘ĞĞ—Ğ« Ğ”ĞĞĞĞ«Ğ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ”§ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..."

# Ğ–Ğ´Ñ‘Ğ¼ Ğ¿Ğ¾ĞºĞ° Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ±ÑƒĞ´ĞµÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°
until docker compose exec db pg_isready -U shop_user -d shop_db; do
  echo "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° PostgreSQL..."
  sleep 2
done

echo "âœ… PostgreSQL Ğ³Ğ¾Ñ‚Ğ¾Ğ²!"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ñ‡ĞµÑ€ĞµĞ· backend
docker compose exec backend python -c "
from database import engine, Base
from models import User, Item, Cart, Order, OrderItem
Base.metadata.create_all(bind=engine)
print('âœ… Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹!')
"

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´ĞµĞ¼Ğ¾-Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹
docker compose exec backend python -c "
from database import SessionLocal
from models import Item

db = SessionLocal()

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ ÑƒĞ¶Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹
if db.query(Item).count() == 0:
    items = [
        Item(name='iPhone 14 Pro', price=89990, desc='Ğ¤Ğ»Ğ°Ğ³Ğ¼Ğ°Ğ½ÑĞºĞ¸Ğ¹ ÑĞ¼Ğ°Ñ€Ñ‚Ñ„Ğ¾Ğ½ Apple Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ñ€Ğ¾Ğ¼ A16 Bionic', img='/img/i17.jpg', category='phones'),
        Item(name='PlayStation 5', price=49990, desc='Ğ˜Ğ³Ñ€Ğ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ĞºĞ¾Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Sony', img='/img/ps5.png', category='consoles'),
        Item(name='Xbox Series X', price=44990, desc='ĞœĞ¾Ñ‰Ğ½Ğ°Ñ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Ğ¾Ñ‚ Microsoft', img='/img/xbox.png', category='consoles'),
        Item(name='Nintendo Switch OLED', price=34990, desc='ĞŸĞ¾Ñ€Ñ‚Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Ñ OLED ÑĞºÑ€Ğ°Ğ½Ğ¾Ğ¼', img='/img/switch.jpeg', category='consoles'),
    ]
    db.add_all(items)
    db.commit()
    print('âœ… Ğ”ĞµĞ¼Ğ¾-Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹!')
else:
    print('â„¹ï¸  Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚')

db.close()
"

echo "ğŸ‰ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!"
